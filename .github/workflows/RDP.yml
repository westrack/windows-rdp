name: RDP

on: [workflow_dispatch]

jobs:
  build:
    runs-on: windows-latest
    steps:
      - name: Download ngrok
        run: |
          Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip
          ./ngrok.exe authtoken ${{ 2z96KQ5jwgrOv4cWaiQ7jmSJeh8_UpYhxpLiTy2Y4uFvcXNC }}

      - name: Download and install RDP Wrapper
        run: |
          Invoke-WebRequest -Uri "https://github.com/stascorp/rdpwrap/releases/download/v1.6.2/RDPWrap-v1.6.2.zip" -OutFile "RDPWrap.zip"
          Expand-Archive "RDPWrap.zip" -DestinationPath "RDPWrap"
          cd RDPWrap
          .\install.bat

      - name: Optimize RDP settings for best performance
        run: |
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "UseAdvancedRemoteFXGraphics" -Value 1 -Type DWord
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services" -Name "EnableHardwareEncode" -Value 1 -Type DWord

      - name: Enable RDP and Start ngrok
        run: |
          net user kamel123 ${{ secrets.RDP_PASSWORD }} /add
          net localgroup administrators kamel123 /add
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name 'fDenyTSConnections' -Value 0
          Enable-NetFirewallRule -DisplayGroup "Remote Desktop"
          Start-Process -NoNewWindow -FilePath .\ngrok.exe -ArgumentList "tcp 3389"
